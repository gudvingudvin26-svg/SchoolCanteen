<!DOCTYPE html>
<html>
<head>
    <title>Профиль</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">Школьная столовая</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'home' %}">Главная</a>
                {% if user.role == 'student' %}
                    <a class="nav-link" href="{% url 'menu_list' %}">Меню</a>
                    <a class="nav-link" href="{% url 'order_history' %}">Заказы</a>
                    <a class="nav-link" href="{% url 'my_subscriptions' %}">Абонементы</a>
                {% elif user.role == 'cook' %}
                    <a class="nav-link" href="{% url 'cook_dashboard' %}">Панель повара</a>
                    <a class="nav-link" href="{% url 'inventory_list' %}">Склад</a>
                {% elif user.role == 'admin' %}
                    <a class="nav-link" href="{% url 'reports_dashboard' %}">Отчеты</a>
                    <a class="nav-link" href="{% url 'purchase_request_list' %}">Заявки</a>
                {% endif %}
                <a class="nav-link" href="{% url 'logout' %}">Выйти</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'success' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-circle"></i> Информация профиля
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="bi bi-person-circle" style="font-size: 5rem; color: #0d6efd;"></i>
                            <h4 class="mt-2">{{ user.first_name }} {{ user.last_name }}</h4>
                            <span class="badge bg-info fs-6">{{ user.get_role_display }}</span>
                        </div>
                        <hr>
                        <table class="table table-borderless">
                            <tr>
                                <th><i class="bi bi-person"></i> Username:</th>
                                <td>{{ user.username }}</td>
                            </tr>
                            <tr>
                                <th><i class="bi bi-envelope"></i> Email:</th>
                                <td>{{ user.email }}</td>
                            </tr>
                            {% if user.role == 'student' %}
                                <tr>
                                    <th><i class="bi bi-building"></i> Класс:</th>
                                    <td>{{ user.class_number }}</td>
                                </tr>
                                <tr>
                                    <th><i class="bi bi-wallet2"></i> Баланс:</th>
                                    <td><h4 class="text-success mb-0">{{ user.balance }} ₽</h4></td>
                                </tr>
                            {% endif %}
                        </table>
                        {% if user.role == 'student' %}
                            <a href="{% url 'add_balance' %}" class="btn btn-success w-100 mt-2">
                                <i class="bi bi-cash"></i> Пополнить баланс
                            </a>
                        {% endif %}
                    </div>
                </div>

                {% if user.role == 'student' %}
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up"></i> Моя статистика
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border rounded p-3 bg-light">
                                    <i class="bi bi-basket fs-2 text-primary"></i>
                                    <h3 class="mt-2 mb-0">{{ user.orders.all.count }}</h3>
                                    <small class="text-muted">Всего заказов</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-3 bg-light">
                                    <i class="bi bi-check-circle fs-2 text-success"></i>
                                    <h3 class="mt-2 mb-0">{{ user.orders.completed.count }}</h3>
                                    <small class="text-muted">Получено</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-3 bg-light">
                                    <i class="bi bi-star fs-2 text-warning"></i>
                                    <h3 class="mt-2 mb-0">{{ user.reviews.all.count }}</h3>
                                    <small class="text-muted">Отзывов</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            {% if user.role == 'student' %}
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Аллергены
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'update_allergies' %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="allergies" value="Глютен" id="allergy1" {% if user.allergies.all %}{% for allergy in user.allergies.all %}{% if allergy.name == 'Глютен' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="allergy1">Глютен</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="allergies" value="Лактоза" id="allergy2" {% if user.allergies.all %}{% for allergy in user.allergies.all %}{% if allergy.name == 'Лактоза' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="allergy2">Лактоза</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="allergies" value="Орехи" id="allergy3" {% if user.allergies.all %}{% for allergy in user.allergies.all %}{% if allergy.name == 'Орехи' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="allergy3">Орехи</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="allergies" value="Яйца" id="allergy4" {% if user.allergies.all %}{% for allergy in user.allergies.all %}{% if allergy.name == 'Яйца' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="allergy4">Яйца</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="allergies" value="Рыба" id="allergy5" {% if user.allergies.all %}{% for allergy in user.allergies.all %}{% if allergy.name == 'Рыба' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="allergy5">Рыба</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="allergies" value="Соя" id="allergy6" {% if user.allergies.all %}{% for allergy in user.allergies.all %}{% if allergy.name == 'Соя' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="allergy6">Соя</label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="bi bi-save"></i> Сохранить аллергены
                            </button>
                        </form>

                        <div class="mt-4">
                            <h6 class="fw-bold">Мои аллергены:</h6>
                            <div>
                                {% for allergy in user.allergies.all %}
                                    <span class="badge bg-danger me-1 p-2">
                                        <i class="bi bi-exclamation-circle"></i> {{ allergy.name }}
                                    </span>
                                {% empty %}
                                    <span class="text-muted">Нет указанных аллергенов</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-heart"></i> Предпочтения в еде
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'update_preferences' %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="preferences" value="Вегетарианское" id="pref1" {% if user.preferences.all %}{% for pref in user.preferences.all %}{% if pref.name == 'Вегетарианское' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="pref1">Вегетарианское</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="preferences" value="Без сахара" id="pref2" {% if user.preferences.all %}{% for pref in user.preferences.all %}{% if pref.name == 'Без сахара' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="pref2">Без сахара</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="preferences" value="Безглютеновое" id="pref3" {% if user.preferences.all %}{% for pref in user.preferences.all %}{% if pref.name == 'Безглютеновое' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="pref3">Безглютеновое</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" name="preferences" value="Безлактозное" id="pref4" {% if user.preferences.all %}{% for pref in user.preferences.all %}{% if pref.name == 'Безлактозное' %}checked{% endif %}{% endfor %}{% endif %}>
                                        <label class="form-check-label" for="pref4">Безлактозное</label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="bi bi-save"></i> Сохранить предпочтения
                            </button>
                        </form>

                        <div class="mt-4">
                            <h6 class="fw-bold">Мои предпочтения:</h6>
                            <div>
                                {% for pref in user.preferences.all %}
                                    <span class="badge bg-success me-1 p-2">
                                        <i class="bi bi-check-circle"></i> {{ pref.name }}
                                    </span>
                                {% empty %}
                                    <span class="text-muted">Нет указанных предпочтений</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="bi bi-star"></i> Мои последние отзывы
                        </h5>
                    </div>
                    <div class="card-body">
                        {% with user.reviews.all|slice:":5" as recent_reviews %}
                            {% for review in recent_reviews %}
                                <div class="border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="fs-6">{{ review.dish.name }}</strong>
                                            <span class="badge bg-secondary ms-2">{{ review.dish.get_meal_type_display }}</span>
                                        </div>
                                        <div>
                                            {% for i in "12345"|make_list %}
                                                {% if forloop.counter <= review.rating %}
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                {% else %}
                                                    <i class="bi bi-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <p class="mt-2 mb-1">{{ review.comment|truncatechars:100 }}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> {{ review.created_at|date:"d.m.Y H:i" }}
                                    </small>
                                </div>
                            {% empty %}
                                <div class="text-center py-4">
                                    <i class="bi bi-star fs-1 text-muted"></i>
                                    <h6 class="mt-3 text-muted">Вы еще не оставили ни одного отзыва</h6>
                                    <a href="{% url 'menu_list' %}" class="btn btn-primary mt-2">
                                        <i class="bi bi-star"></i> Оценить блюда
                                    </a>
                                </div>
                            {% endfor %}

                            {% if user.reviews.all.count > 5 %}
                                <div class="text-center mt-3">
                                    <a href="#" class="btn btn-outline-primary btn-sm">
                                        Все отзывы ({{ user.reviews.all.count }})
                                    </a>
                                </div>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if user.role == 'cook' %}
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-tools"></i> Инструменты повара
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <a href="{% url 'cook_dashboard' %}" class="btn btn-primary w-100 p-3">
                                    <i class="bi bi-clipboard-check fs-4"></i>
                                    <br>
                                    Панель управления
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'inventory_list' %}" class="btn btn-success w-100 p-3">
                                    <i class="bi bi-box fs-4"></i>
                                    <br>
                                    Склад продуктов
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'inventory_alerts' %}" class="btn btn-warning w-100 p-3">
                                    <i class="bi bi-exclamation-triangle fs-4"></i>
                                    <br>
                                    Остатки
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'purchase_request_create' %}" class="btn btn-info w-100 p-3">
                                    <i class="bi bi-cart-plus fs-4"></i>
                                    <br>
                                    Заявка на закупку
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if user.role == 'admin' %}
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear"></i> Панель администратора
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <a href="{% url 'reports_dashboard' %}" class="btn btn-primary w-100 p-3">
                                    <i class="bi bi-file-earmark-text fs-4"></i>
                                    <br>
                                    Отчеты
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'purchase_request_list' %}" class="btn btn-warning w-100 p-3">
                                    <i class="bi bi-cart-check fs-4"></i>
                                    <br>
                                    Заявки на закупку
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/admin/" class="btn btn-danger w-100 p-3">
                                    <i class="bi bi-shield-lock fs-4"></i>
                                    <br>
                                    Админ-панель Django
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'finance_report' %}" class="btn btn-success w-100 p-3">
                                    <i class="bi bi-graph-up fs-4"></i>
                                    <br>
                                    Финансы
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>